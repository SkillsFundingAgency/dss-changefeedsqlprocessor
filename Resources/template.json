{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "appInsightsInstrumentationKey":{
      "type": "string"
    },
    "changeFeedProcessorPrefix": {
      "type": "string"
    },
    "serviceBusConnectionString": {
      "type": "string"
    },
    "functionAppSuffix": {
      "type": "string"
    },
    "sqlConnectionString": {
      "type": "string"
    },
    "storageAccountName": {
      "type": "string"
    },
    "storageAccountKey": {
      "type": "string"
    }
  },
  "variables": {
    "environmentName": "[toUpper(split(parameters('changeFeedProcessorPrefix'), '-')[1])]",
    "functionAppName": "[toLower(concat(parameters('changeFeedProcessorPrefix'), '-fa', parameters('functionAppSuffix')))]",
    "storageAccountConnectionString": "[concat('DefaultEndpointsProtocol=https;AccountName=',parameters('storageAccountName'),';AccountKey=', parameters('storageAccountKey'), ';EndpointSuffix=core.windows.net')]"
  },
  "resources": [
    {
      "type": "Microsoft.Web/sites/config",
      "apiVersion": "2023-12-01",
      "name": "[format('{0}/{1}', parameters('functionAppName'), 'appsettings')]",
      "properties": {
        "EnvironmentName": "[variables('environmentName')]",
        "FUNCTIONS_EXTENSION_VERSION": "~4",
        "FUNCTIONS_WORKER_RUNTIME": "dotnet-isolated",
        "MSDEPLOY_RENAME_LOCKED_FILES": "1",
        "AzureWebJobsStorage": "[variables('storageAccountConnectionString')]",
        "APPINSIGHTS_INSTRUMENTATIONKEY": "[parameters('appInsightsInstrumentationKey')]",
        "QueueName": "dss.changefeedqueue",
        "ServiceBusConnectionString": "[parameters('serviceBusConnectionString')]",
        "SQLConnString": "[parameters('sqlConnectionString')]"
      }
    },
    {
      "type": "Microsoft.Web/sites/config",
      "apiVersion": "2023-12-01",
      "name": "[format('{0}/{1}', parameters('functionAppName'), 'connectionstrings')]",
      "properties": {}
    }
  ],
  "outputs": {}
}